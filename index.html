<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Gate Stretch Timer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<!-- TensorFlow.js + COCO-SSD -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 12px;
  background: #111;
  color: #eee;
}
button {
  padding: 10px;
  margin: 4px 0;
  width: 100%;
  font-size: 16px;
}
#video {
  width: 100%;
  max-height: 40vh;
  background: black;
}
#canvas {
  display: none;
}
.toggle button.active {
  background: #2e8bff;
  color: white;
}
#timer {
  width: 200px;
  height: 200px;
  margin: 16px auto;
  border-radius: 50%;
  border: 8px solid #444;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
}
#hud {
  font-size: 12px;
  white-space: pre-wrap;
  display: none;
  background: #222;
  padding: 6px;
  margin-top: 8px;
}
</style>
</head>

<body>

<h2>ã‚¹ãƒˆãƒ¬ãƒƒãƒè¨˜éŒ²</h2>

<div class="toggle">
  <button onclick="selectExercise('calf')">è…“è…¹ç­‹</button>
  <button onclick="selectExercise('hip')">è‚¡é–¢ç¯€</button>
  <button onclick="selectExercise('rectus')">å¤§è…¿ç›´ç­‹</button>
  <button onclick="selectExercise('bridge')">ãƒ’ãƒƒãƒ—ã‚¢ãƒƒãƒ—</button>
</div>

<button onclick="startCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
<video id="video" autoplay playsinline></video>

<button onclick="capture()">ğŸ“¸ é™æ­¢ç”»æ’®å½±</button>

<div id="timer" hidden>20</div>
<button id="finishBtn" hidden onclick="finishStretch()">è¨˜éŒ²ã™ã‚‹</button>

<button onclick="toggleHud()">HUDãƒ­ã‚°åˆ‡æ›¿</button>
<div id="hud"></div>

<canvas id="canvas"></canvas>

<script>
let model;
let stream;
let exercise = null;
let cocoOK = false;
let timerInterval;
let seconds = 20;

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const hud = document.getElementById('hud');
const timerEl = document.getElementById('timer');
const finishBtn = document.getElementById('finishBtn');

log('init');

async function loadModel() {
  model = await cocoSsd.load();
  log('COCO loaded');
}
loadModel();

function selectExercise(type) {
  exercise = type;
  document.querySelectorAll('.toggle button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  log('exercise=' + type);
}

async function startCamera() {
  stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
  video.srcObject = stream;
  log('camera started');
}

async function capture() {
  if (!exercise) {
    alert('ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);

  const preds = await model.detect(canvas);
  log(JSON.stringify(preds.map(p => p.class)));

  cocoOK = preds.some(p => p.class === 'person');

  if (!cocoOK) {
    alert('è„šï¼ˆäººï¼‰ãŒèªè­˜ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
    return;
  }

  startTimer();
}

function startTimer() {
  seconds = 20;
  timerEl.hidden = false;
  finishBtn.hidden = true;
  timerEl.textContent = seconds;
  log('timer start');

  timerInterval = setInterval(() => {
    seconds--;
    timerEl.textContent = seconds;
    if (seconds <= 0) {
      clearInterval(timerInterval);
      finishBtn.hidden = false;
      log('timer done');
    }
  }, 1000);
}

function finishStretch() {
  saveCSV();
  timerEl.hidden = true;
  finishBtn.hidden = true;
  log('saved');
}

function saveCSV() {
  const now = new Date();
  const date = now.toISOString().split('T')[0];
  const time = now.toTimeString().split(' ')[0];
  const csv =
`date,time,exercise,duration_sec,coco_ok
${date},${time},${exercise},20,${cocoOK}`;

  const filename = `stretch_log_${date}_${time.replace(/:/g,'-')}.csv`;
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

function toggleHud() {
  hud.style.display = hud.style.display === 'none' ? 'block' : 'none';
}

function log(msg) {
  hud.textContent += msg + '\n';
}
</script>

</body>
</html>
